task.wait(30)

-- ‚öôÔ∏è C·∫•u h√¨nh
local checkDelay = 60
local stuckTimeout = 60
local noLevelUpTimeout = 180
local nearbyRadius = 30
local levelMax = 2650

-- üì¶ D·ªãch v·ª• Roblox
local Players = game:GetService("Players")
local TeleportService = game:GetService("TeleportService")
local HttpService = game:GetService("HttpService")
local LocalPlayer = Players.LocalPlayer

-- üß† Bi·∫øn theo d√µi
local lastPosition = nil
local stuckTime = 0
local lastLevel = LocalPlayer.Data.Level.Value
local lastLevelChange = os.time()

-- üîÅ ƒê·ªïi server
local function hopToServer()
    print("üîÅ ƒêang t√¨m server m·ªõi...")
    local success = pcall(function()
        local url = "https://games.roblox.com/v1/games/" .. game.PlaceId .. "/servers/Public?sortOrder=Asc&limit=100"
        local response = HttpService:JSONDecode(game:HttpGet(url))
        local best, minPlayers = nil, math.huge

        for _, server in ipairs(response.data) do
            if server.id ~= game.JobId and server.playing < server.maxPlayers and server.playing < minPlayers then
                best = server
                minPlayers = server.playing
            end
        end

        if best then
            print("üåê ƒêang chuy·ªÉn ƒë·∫øn server c√≥", best.playing, "ng∆∞·ªùi.")
            TeleportService:TeleportToPlaceInstance(game.PlaceId, best.id, LocalPlayer)
        else
            print("‚ö†Ô∏è Kh√¥ng t√¨m th·∫•y server kh√°c, th·ª≠ rejoin.")
            TeleportService:Teleport(game.PlaceId)
        end
    end)

    if not success then
        print("‚ùå L·ªói khi teleport, rejoin l·∫°i...")
        TeleportService:Teleport(game.PlaceId)
    end
end

-- üßç Ki·ªÉm tra b·ªã ƒë·ª©ng y√™n
local function checkStuck()
    local char = LocalPlayer.Character
    if char and char:FindFirstChild("HumanoidRootPart") then
        local pos = char.HumanoidRootPart.Position
        if lastPosition and (pos - lastPosition).Magnitude < 1 then
            stuckTime += checkDelay
            print("üìå ƒê·ª©ng y√™n:", stuckTime, "gi√¢y")
            if stuckTime >= stuckTimeout then
                print("‚ö†Ô∏è B·ªã k·∫πt qu√° l√¢u ‚Üí hop")
                hopToServer()
            end
        else
            stuckTime = 0
        end
        lastPosition = pos
    end
end

-- üë• Ki·ªÉm tra ng∆∞·ªùi ch∆°i g·∫ßn
local function isNearPlayer()
    local myChar = LocalPlayer.Character
    if not myChar or not myChar:FindFirstChild("HumanoidRootPart") then return false end
    local myPos = myChar.HumanoidRootPart.Position

    for _, plr in ipairs(Players:GetPlayers()) do
        if plr ~= LocalPlayer and plr.Character and plr.Character:FindFirstChild("HumanoidRootPart") then
            local dist = (myPos - plr.Character.HumanoidRootPart.Position).Magnitude
            print("üë§", plr.Name, "c√°ch", math.floor(dist), "studs")
            if dist <= nearbyRadius then return true end
        end
    end
    return false
end

-- üìà Ki·ªÉm tra kh√¥ng l√™n c·∫•p
task.spawn(function()
    while true do
        local level = LocalPlayer.Data.Level.Value
        print("üéØ Level hi·ªán t·∫°i:", level)
        if level < levelMax then
            if level > lastLevel then
                lastLevel = level
                lastLevelChange = os.time()
            elseif os.time() - lastLevelChange >= noLevelUpTimeout then
                print("‚ö†Ô∏è Kh√¥ng l√™n c·∫•p sau", noLevelUpTimeout, "gi√¢y ‚Üí hop")
                hopToServer()
            end
        else
            print("‚úÖ Level max, d·ª´ng ki·ªÉm tra level.")
            break
        end
        task.wait(600)
    end
end)

-- üîÅ Lu·ªìng ch√≠nh ki·ªÉm tra stuck + ng∆∞·ªùi g·∫ßn
task.spawn(function()
    while true do
        if LocalPlayer.Data.Level.Value < levelMax then
            if isNearPlayer() then
                print("üë• C√≥ ng∆∞·ªùi ch∆°i g·∫ßn! ƒê·ª£i 60s r·ªìi hop...")
                task.wait(60)
                hopToServer()
            end
            checkStuck()
        else
            print("‚úÖ Level max, kh√¥ng c·∫ßn ki·ªÉm tra n·ªØa.")
        end
        task.wait(checkDelay)
    end
end)

-- ü§ù Auto k·∫øt b·∫°n ng∆∞·ªùi g·∫ßn
task.spawn(function()
    task.wait(30)
    while task.wait(60) do
        pcall(function()
            for _, player in ipairs(Players:GetPlayers()) do
                if player ~= LocalPlayer and not player:IsFriendsWith(LocalPlayer.UserId) then
                    LocalPlayer:RequestFriendship(player)
                    task.wait(1)
                end
            end
        end)
    end
end)
